<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge, chrome=1" />
    <title>Sentinel Hub WMS services with Leaflet</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

        #map {
            height: 96%;
            width: 100%;
        }
    </style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" />
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  {% include "js/L.TileLayer.BetterWMS.js" %}
</head>

<body>
  <!-- Search form -->
<input class="form-control" type="text" placeholder="Buscar por área" aria-label="Search" style="z-index:9999;" id="scriptBox" onkeypress="return runScript(event)">
<div id="map"></div>
<script>
// OpenStreetMap
let osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
});

var url = 'http://adesur.centrogeo.org.mx/geoserver/gwc/service/wms';

let polygons = L.tileLayer.wms(url, {
    layers: 'geonode:poligonos_agricultura',
    format: 'image/png',
    transparent: true,
    attribution: "CG"
});

// Sentinel Hub WMS service
// tiles generated using EPSG:3857 projection - Leaflet takes care of that
let baseUrl = "https://services.sentinel-hub.com/ogc/wms/538f72f2-3777-49c7-8177-6d74964d74f8";
let false_color = L.tileLayer.wms(baseUrl, {
    tileSize: 512,
    attribution: '&copy; <a href="http://www.sentinel-hub.com/" target="_blank">Sentinel Hub</a>',
    urlProcessingApi:"https://services.sentinel-hub.com/ogc/wms/aeafc74a-c894-440b-a85b-964c7b26e471",
 	maxcc:20,
 	minZoom:6,
 	maxZoom:16,
 	preset:"FALSE_COLOR",
 	layers:"FALSE_COLOR",
 	time:"2019-08-01/2019-09-29",

});
let ndvi = L.tileLayer.wms(baseUrl, {
    tileSize: 512,
    attribution: '&copy; <a href="http://www.sentinel-hub.com/" target="_blank">Sentinel Hub</a>',
    urlProcessingApi:"https://services.sentinel-hub.com/ogc/wms/aeafc74a-c894-440b-a85b-964c7b26e471",
 	maxcc:20,
 	minZoom:6,
 	maxZoom:16,
 	preset:"NDVI",
 	layers:"NDVI",
 	time:"2019-08-01/2019-09-29",

});
let urban = L.tileLayer.wms(baseUrl, {
    tileSize: 512,
    attribution: '&copy; <a href="http://www.sentinel-hub.com/" target="_blank">Sentinel Hub</a>',
    urlProcessingApi:"https://services.sentinel-hub.com/ogc/wms/aeafc74a-c894-440b-a85b-964c7b26e471",
 	maxcc:20,
 	minZoom:6,
 	maxZoom:16,
 	preset:"FALSE_COLOR_URBAN",
 	layers:"FALSE_COLOR_URBAN",
 	time:"2019-08-01/2019-09-29",

});
let agriculture = L.tileLayer.wms(baseUrl, {
    tileSize: 512,
    attribution: '&copy; <a href="http://www.sentinel-hub.com/" target="_blank">Sentinel Hub</a>',
    urlProcessingApi:"https://services.sentinel-hub.com/ogc/wms/aeafc74a-c894-440b-a85b-964c7b26e471",
 	maxcc:20,
 	minZoom:6,
 	maxZoom:16,
 	preset:"AGRICULTURE",
 	layers:"AGRICULTURE",
 	time:"2019-08-01/2019-09-29",

});

let bathymetric = L.tileLayer.wms(baseUrl, {
    tileSize: 512,
    attribution: '&copy; <a href="http://www.sentinel-hub.com/" target="_blank">Sentinel Hub</a>',
    urlProcessingApi:"https://services.sentinel-hub.com/ogc/wms/aeafc74a-c894-440b-a85b-964c7b26e471",
 	maxcc:20,
 	minZoom:6,
 	maxZoom:16,
 	preset:"BATHYMETRIC",
 	layers:"BATHYMETRIC",
 	time:"2019-08-01/2019-09-29",

});


let baseMaps = {
    'NDVI': ndvi,
    'False Color (Vegetation)':false_color,
    'False Color (urban)':urban,
    'Agriculture':agriculture,
    'Gray':osm
};
let overlayMaps = {
    'Agricultura': polygons
}

let map = L.map('map', {
    center: [17.887699, -94.8586217], // lat/lng in EPSG:4326
    zoom: 13,
    layers: [osm, polygons]
});

L.control.layers(baseMaps, overlayMaps).addTo(map);

      L.tileLayer.betterWms(url, {
        layers: 'geonode:poligonos_agricultura',
        transparent: true,
        format: 'image/png'
   }).addTo(map);

   function runScript(e) {
     if (e.keyCode == 13) {
      var tb = document.getElementById("scriptBox");
      //isNan evalua un argumento para determinar si es un número
      if (isNaN(tb.value)){
          alert("ingresa un área valida");
      }
      else {
        //si es número nos vamos al método searchData
        searchData(tb.value);
      }
    }
   }
//searchdata tiene como parametros area,
//buscamos el aŕea del poligono vía ajax, con el método search_area, haciendo uso de GET
function searchData(area) {
$.ajax({
   url: '{% url "search_area" %}',
   data: {'area': area},
   type: 'GET',
   success : function(data) {
     //si no existe el área, entonces mandamos un mensaje de busqueda no encontrada
       if (data.features.length==0) {
         alert("No hay un área con esos valores")
         return false;
       }
       //si es la primera consulta no removemos el geojson
       if (typeof(activityGeojson)!='undefined') {
         map.removeLayer(activityGeojson);
       }
       /* Eventos del geojson */
       function onEachCommonFeature(feature, layer) {
         //abrimos el popup del poligono que se ingreso
           layer.bindPopup('<div>area:<br><strong>'+feature.properties.area+'</strong></div>'+
            '<div>descripción:<br><strong>'+feature.properties.description+'</strong></div>'
         );
           layer.on('mouseover', function() {
               layer.openPopup();
           });
           layer.on('mouseout', function() { layer.closePopup(); });
       }
       /* Geojson de capas */
       activityGeojson = L.geoJson(data, {
           onEachFeature: onEachCommonFeature,
           style: function(feature) {
             //coloreamos el poligono ingresado desde el input search y le ponemos transparencia al geojson
               return { fillColor: "#b942f5", color: "#f54299", weight: 1, fillOpacity: 0.5 };
           }
       }).addTo(map);
       //vamos al zoom del poligono que se ingreso desde el input
       map.fitBounds(activityGeojson.getBounds());
   },
   error : function(message) {
           console.log(message);
   }
});
}
        </script>
</body>
</html>
